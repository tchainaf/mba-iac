# Instalação Ansible

1. No menu do EC2, crie uma Key Pair do tipo `RSA` e formato `.pem`, guardando o arquivo criado ao final
2. Crie uma EC2 (SERVIDOR PRINCIPAL), com imagem **Ubuntu**, a Key Pair criada no passo 1 e o restante das configurações como padrão
3. Edite o security group criado, adicionando uma nova regra de entrada, do tipo `Custom ICMP - IPv4`, protocolo `Echo Request` e CIDR blocks `0.0.0.0/0`. As regras devem ficar como a imagem abaixo
![](sg.png)
4. Conecte-se a EC2 criada, usando o método `EC2 Instance Connect` ou o `SSH client`(precisa da chave .pem)
5. Instale o ansible, usando os comandos abaixo - baseado no [passo a passo](https://github.com/mvm-sp/iac-devops/blob/main/Appendix/Ansible/01-ubuntu-boto3.md) do professor
```
sudo apt update -y
sudo apt upgrade
sudo apt install -y python3 python3-pip

sudo apt install pipx -y
pipx install boto
pipx install boto3
pipx install ansible
pipx install ansible-core

# Verifique se o ansible foi instalado corretamente
ansible --version
```

6. Crie a pasta `files`
```
mkdir files && cd files
```

7. Crie o arquivo `.pem` com o MESMO NOME da sua chave criada no passo 1
```
touch <NOME DA SUA CHAVE>.pem
```

8. Cole o conteúdo do arquivo `.pem` criado no passo 1 e salve o arquivo
```
chmod 400 <NOME DA SUA CHAVE>.pem
vim <NOME DA SUA CHAVE>.pem
```

9. Crie mais **duas** instâncias EC2 (SERVIDORES NODE), com imagem **Ubuntu**, a Key Pair criada no passo 1 e o security group já existente:
![](criacao-ec2.png)

10. Através do SERVIDOR PRINCIPAL, conecte-se em uma das novas instâncias EC2 SERVIDOR NODE, usando o método o `SSH client`
11. Após uma conexão com sucesso, pode usar o comando `exit` para voltar para a EC2 SERVIDOR PRINCIPAL
12. Crie uma nova chave SSH e imprima e COPIE o conteúdo
```
cd ~/.ssh
ssh-keygen -t rsa -f id_rsa -q -P ""
cat id_rsa.pub
```

13. Conecte-se novamente aos SERVIDORES NODES
```
cd ../files
# Comando SSH usado no passo 10
```

14. Nos servidores NODES, cadastre a chave SSH do SERVIDOR PRINCIPAL
```
vim ~/.ssh/authorized_keys
# Cole em uma nova linha o conteúdo copiado no passo 12 e salve o arquivo
```

15. Use o comando `exit` para voltar para a EC2 SERVIDOR PRINCIPAL e crie o arquivo hosts
```
touch hosts
vim hosts
```

16. Dentro do arquivo hosts, coloque os IPs (públicos e privados) dos SERVIDORES NODES conforme a estrutura abaixo
```
[posmack]
34.239.118.74
18.208.115.176

[posmack_internal]
172.31.91.193
172.31.80.105
```

17. Dê um ping nos SERVIDORES NODES através do ansible
```
ansible -i hosts posmack -m ping
# Permita a conexão dos dois servidores
yes
yes
```

18. Execute o upgrade e update nos SERVIDORES NODE
```
ansible -i hosts -m shell -a 'apt update -y' posmack --become
ansible -i hosts -m shell -a 'apt upgrade' posmack --become
```